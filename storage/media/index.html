<!DOCTYPE html>
<html>
    <head>
        <title>Project Amor v1.0.0</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap');
            * {
                border: 0;
                padding: 0;
                margin: 0;
                outline: none;
                user-select: none;
                font-family: "Orbitron", sans-serif;
                font-optical-sizing: auto;
                transition: all 0.25s, font-weight 0s;
            }
            body {
                font-size: 16px;
                line-height: 16px;
                font-weight: 400;
                background-color: #000000;
                color: #FFFFFF;
            }
            .screen {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: none;
                align-items: center;
                justify-content: center;
            }
            .screen .tab {
                display: none;
            }
            .screen#login-screen .tab#login-tab ul {
                list-style-type: none;
            }
            .screen#login-screen .tab#loading-tab h1.logo, .screen#login-screen .tab#login-tab ul li h1.logo {
                font-size: calc(16px * 1.75);
                line-height: calc(16px * 1.75);
                color: #FFFFFF;
                width: 100%;
            }
            .screen#login-screen .tab#login-tab ul li {
                margin: 16px 0px;
            }
            .screen#login-screen .tab#login-tab ul li span {
                display: block;
                font-size: calc(16px/1.25);
                margin-bottom: calc(16px/3)
            }
            .screen#default-screen ul.navigation {
                position: relative;
                width: calc(16px * 20.25 - (16px * 2) - 1.6px);
                height: calc(100% - (16px * 2));
                list-style-type: none;
                padding: 16px;
                display: block;
                border-right: 1.6px solid rgba(255, 255, 255, 0.125);
            }
            .screen#default-screen ul.navigation li:has(h1.logo) {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px 16px;
                padding-bottom: calc(16px + 4px);
                color: #AAAAAA;
                font-size: 16px;
            }
            .screen#default-screen ul.navigation li:has(h1.logo) h1.logo {
                color: #FFFFFF;
                font-size: calc(16px * 1.25);
                line-height: calc(16px * 1.25);
                width: 100%;
            }
            .screen#default-screen ul.navigation li a {
                display: block;
                color: #FFFFFF;
                font-size: calc(16px * 1.5);
                line-height: calc(16px * 1.5);
                text-decoration: none;
                padding: 8px 16px;
            }
            .screen#default-screen ul.navigation li a.active, .screen#default-screen ul.navigation li a:hover {
                font-weight: 600;
                font-size: calc(16px * 1.5 * 1.5);
                line-height: calc(16px * 1.5 * 1.5)
            }
            .screen#default-screen ul.navigation li a:not(.active):hover {
                opacity: 0.5;
            }
            .screen#default-screen ul.navigation li a.active[onclick="selectTab('home-tab')"], .screen#default-screen ul.navigation li a[onclick="selectTab('home-tab')"]:hover {
                color: #F93A2F;
            }
            .screen#default-screen ul.navigation li a.active[onclick="selectTab('missions-tab')"], .screen#default-screen ul.navigation li a[onclick="selectTab('missions-tab')"]:hover {
                color: #F8C300;
            }
            .screen#default-screen ul.navigation li a.active[onclick="selectTab('communities-tab')"], .screen#default-screen ul.navigation li a[onclick="selectTab('communities-tab')"]:hover {
                color: #00D166;
            }
            .screen#default-screen ul.navigation li a.active[onclick="selectTab('inbox-tab')"], .screen#default-screen ul.navigation li a[onclick="selectTab('inbox-tab')"]:hover {
                color: #0099E1;
            }
            .screen#default-screen ul.navigation li:has(.info) {
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                bottom: calc(16px + 8px);
                left: 32px;
                right: 32px;
            }
            .screen#default-screen ul.navigation li:has(.info) .info {
                width: 100%;
            }
            .screen#default-screen ul.navigation li:has(.info) .info h1 {
                font-size: calc(16px * 1.1);
                margin-bottom: calc(16px/3)
            }
            .screen#default-screen ul.navigation li:has(.info) .info p {
                font-size: calc(16px/1.1);
                color: #AAAAAA
            }
            .screen#default-screen ul.navigation li:has(.info) button {
                font-size: calc(16px * 1.375);
                background-color: transparent;
                color: #FFFFFF;
            }
            .screen#default-screen .tab#home-tab {
                background-image: url("/media/c3Bh");
                background-size: 25%;
                background-position: center;
                background-repeat: repeat;
            }
            .screen#default-screen .tab#home-tab ul.dashboard {
                display: flex;
                flex-wrap: wrap;
                list-style-type: none;
                margin: 0px -16px;
            }
            .screen#default-screen .tab#home-tab ul.dashboard li {
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                padding: 16px;
                margin: 16px;
                border-radius: 16px;
                height: 100px;
            }
            .screen#default-screen .tab {
                min-width: calc(100vw - (16px * 20.25));
                height: 100vh;
                position: relative;
            }
            .screen#default-screen .tab#missions-tab #missions-map {
                width: calc(100vw - (16px * 20.25));
                height: 100vh;
                position: relative;
            }
            .screen#default-screen .tab#missions-tab ul.missions {
                backdrop-filter: blur(16px);
                padding: 8px 20px;
                position: absolute;
                top: 16px;
                right: 16px;
                z-index: 100000;
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                border-radius: 16px;
                list-style-type: none;
            }
            .screen#default-screen .tab#missions-tab .missions ul li {
                margin: 8px 0px;
            }
            .screen#default-screen .tab#missions-tab .missions ul li h1.heading, .screen#default-screen .tab#inbox-tab .section h1.heading {
                font-size: calc(16px * 1.5 * 1.25);
                line-height: calc(16px * 1.5 * 1.25);
                padding: 4px 0px;
            }
            .screen#default-screen .tab#missions-tab .missions ul li h2.subheading {
                font-size: calc(16px * 1.125);
                line-height: calc(16px * 1.125);
                padding: 4px 0px;
            }
            .screen#default-screen .tab#missions-tab .missions ul li:not(:has(h1.heading, h2.subheading)) {
                display: flex;
                align-items: center;
                padding: 4px 0px;
                font-size: calc(16px/1.1);
                line-height: calc(16px/1.1)
            }
            .screen#default-screen .tab#missions-tab .missions ul li:not(:has(h1.heading, h2.subheading)):hover,  .screen#default-screen ul.navigation li:has(.info) button:hover {
                transform: scale(1.0375);
            }
            .screen#default-screen .tab#missions-tab .missions ul li:not(:has(h1.heading, h2.subheading)) .checkbox {
                height: calc(16px * 1.75 - (1.6px * 2));
                aspect-ratio: 1;
                border-radius: calc((16px * 1.75)/4);
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                margin-right: calc((16px * 1.75)/2)
            }
            .screen#default-screen .tab#missions-tab .search {
                position: absolute;
                bottom: 16px;
                left: 16px;
                width: 250px;
                z-index: 100000;
            }
            .screen#default-screen .tab#missions-tab .search ul.results {
                margin-bottom: 16px;
                backdrop-filter: blur(16px);
                border: 1.6px solid rgba(255, 255, 255, 0.125);
            }
            .screen#default-screen .tab#missions-tab .search input[type="text"], .screen#login-screen .tab#login-tab ul li input[type="text"] {
                backdrop-filter: blur(16px);
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                padding: calc(16px/1.25) calc((16px/1.25) * 1.25);
                border-radius: 8px;
                color: #FFFFFF;
                font-size: 16px;
                background-color: transparent;
            }
            .screen#default-screen .tab#communities-tab ul.communities {
                width: calc(16px * 20 - 1.6px);
                border-right: 1.6px solid rgba(255, 255, 255, 0.125);
            }
            .screen#default-screen .tab#inbox-tab {
                display: flex;
            }
            .screen#default-screen .tab#inbox-tab .section {
                width: 85%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                height: 85%
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox {
                list-style-type: none;
                width: 100%;
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                border-bottom: 0;
                margin-top: calc(16px/2);
                border-radius: 16px;
                overflow: hidden;
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li {
                border-bottom: 1.6px solid rgba(255, 255, 255, 0.125);
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a {
                display: flex;
                align-items: center;
                width: calc(100% - (8px * 1.5 * 2));
                text-align: left;
                padding: 8px calc(8px * 1.5);
                font-size: 16px;
                background-color: transparent;
                color: #FFFFFF;
                text-decoration: none;
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a:hover {
                background-color: rgba(255, 255, 255, 0.0625);
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a p {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a p.sender {
                min-width: calc(100%/6 - (16px/2));
                font-weight: 500;
                margin-right: calc(16px/2);
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a p.title {
                display: inline-block;
                font-weight: 500;
                margin-right: calc(16px/2);
                min-width: calc(100%/5 - (16px/2))
            }
            .screen#default-screen .tab#inbox-tab .section ul#inbox li a p.timestamp {
                text-align: right;
                min-width: calc(100%/6 - (16px/2));
                margin-left: calc(16px/2)
            }
            .screen#default-screen .tab#inbox-tab .overlay {
                backdrop-filter: blur(16px);
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: none;
                align-items: center;
                justify-content: center;
            }
            .screen#default-screen .tab#inbox-tab .overlay ul.mail {
                border: 1.6px solid rgba(255, 255, 255, 0.125);
                border-radius: 16px;
                list-style-type: none;
                width: 75%;
            }
            .screen#default-screen .tab#inbox-tab .overlay ul.mail li {
                padding: 8px calc(8px * 1.5);
                border-bottom: 1.6px solid rgba(255, 255, 255, 0.125);
            }
            .screen#default-screen .tab#inbox-tab .overlay ul.mail li:last-child {
                border-bottom: 0;
            }
            /*
            .screen#default-screen .tutorial {
                position: fixed;
                left: 50%;
                bottom: 16px;
                transition: translate(-50%, -50%);
                background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 1));
                padding: calc(16px * 1.5) calc(100%/3);
                font-size: calc(16px/1.1);
                color: #DDDDDD;
                text-align: center;
            }
            .screen#default-screen .tutorial h1 {
                font-size: calc(16px * 1.1);
                color: #FFFFFF;
                margin-bottom: calc(16px/2)
            }
                */
        </style>
    </head>
    <body>
        <div class="screen" id="login-screen">
            <div class="tab" id="login-tab">
                <ul>
                    <li>
                        <h1 class="logo">PROJECT<br>AMOR❤️</h1>
                    </li>
                    <li>
                        <span>Username</span>
                        <input type="text" id="login-username">
                    </li>
                </ul>
            </div>
            <div class="tab" id="loading-tab">
                <h1 class="logo">PROJECT<br>AMOR❤️</h1>
            </div>
        </div>
        <div class="screen" id="default-screen">
            <ul class="navigation">
                <li><h1 class="logo">PROJECT<br>AMOR❤️</h1><span>v1.0.0</span></li>
                <li><a id="navigation-home" onclick="selectTab('home-tab')">Home</a></li>
                <li><a id="navigation-missions" onclick="selectTab('missions-tab')">Missions</a></li>
                <li><a id="navigation-communities" onclick="selectTab('communities-tab')">Communities</a></li>
                <li><a id="navigation-inbox" onclick="selectTab('inbox-tab')">Inbox</a></li>
                <li>
                    <div class="info">
                        <h1>Agent Zavier</h1>
                        <p>@zaviergpt</p>
                    </div>
                    <button><i class="fa-solid fa-gear"></i></button>
                </li>
            </ul>
            <div class="tab" id="home-tab" href="/home">
            </div>
            <div class="tab" id="missions-tab" href="/missions">
                <div id="missions-map"></div>
                <div class="missions">
                    <ul class="missions">
                        <li><h1 class="heading">Your Missions</h1></li>
                        <li><h2 class="subheading">Daily Tasks</h2></li>
                        <li><div class="checkbox"></div> Take public transport</li>
                        <li><h2 class="subheading">From Inbox</h2></li>
                        <li></li>
                    </ul>
                </div>
                <div class="search">
                    <ul id="search-results"></ul>
                    <input type="text" id="search-input">
                </div>
            </div>
            <div class="tab" id="communities-tab" href="/communities">
                
            </div>
            <div class="tab" id="inbox-tab" href="/inbox">
                <div class="section">
                    <h1 class="heading">Your Inbox</h1>
                    <ul id="inbox"></ul>
                </div>
                <div class="overlay" id="inbox-overlay">
                    <ul class="mail">
                        <li id="mail-from"><b>From</b></li>
                        <li id="mail-title"></li>
                        <li id="mail-content"></li>
                    </ul>
                </div>
            </div>
            <div class="tutorial">

            </div>
        </div>
    </body>
    <script>
        var map = null
        var profile = null
        var inbox = {}
        const API = (function(){
            return {
                accounts: {
                    async authorizeToken(token=null, username=null, twofactor=null) {
                        request = await (await fetch("/accounts/authorize", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    async authorizeCredentials(username, twofactor) {
                        request = await (await fetch("/accounts/authorize", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    username: username,
                                    twofactor: twofactor
                                }))
                            }
                        })).json()
                        return request
                    },
                    create(username) {
                        
                    }
                },
                events: {
                    async searchQuery(token, query=null, latitude=null, longitude=null) {
                        request = await (await fetch(`/events/search?query=${query.toLowerCase().split(" ").join("+")}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    async searchLocation(token, latitude, longitude) {
                        request = await (await fetch(`/events/search?latitude=${latitude}&longitude=${longitude}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    async create(token, name, description, start_time, end_time, latitude, longitude) {
                        request = await (await fetch("/events/create", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            },
                            body: JSON.stringify({
                                name: name,
                                description: description,
                                scheduled: {
                                    start: start_time,
                                    end: end_time
                                },
                                location: {
                                    latitude: latitude,
                                    longitude: longitude
                                },
                                public: true
                            })
                        })).json()
                        return request
                    },
                    async get(token, id) {
                        request = await (await fetch(`/events/` + id, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    async join(token, id) {
                        request = await (await fetch(`/events/` + id + "/join", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    }
                },
                inbox: {
                    async all(token) {
                        request = await (await fetch("/inbox", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    }
                },
                communities: {
                    async search(token, query) {
                        request = await (await fetch("/communities/search?query=" + query, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    async create(token, name, description, tags) {
                        request = await (await fetch("/communities/create" + query, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            },
                            body: JSON.stringify({
                                name: name,
                                description: description,
                                tags: tags
                            })
                        })).json()
                        return request
                    },
                    async get(token, id) {
                        request = await (await fetch("/communities/" + id, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    }
                },
                missions: {
                    async all(token) {
                        request = await (await fetch("/missions", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            }
                        })).json()
                        return request
                    },
                    verify(token, id) {

                    },
                    async accept(token, mailId) {
                        request = await (await fetch("/missions/accept/" + mailId, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": btoa(JSON.stringify({
                                    token: token
                                }))
                            },
                            body: JSON.stringify({
                                mailId: mailId
                            })
                        })).json()
                        return request
                    }
                }
            }
        })()
        function speak(message) {
            var characters = ""
            const content = document.getElementById("mail-content")
            speaking = setInterval(function(){
                if (characters.length === message.length) {
                    clearInterval(speaking)
                } else {
                    characters += message[characters.length]
                    content.innerHTML = characters
                }
            }, 100/1.5)
        }
        async function selectTab(id) {
            const tabs = document.getElementsByClassName("tab")
            const screens = document.getElementsByClassName("screen")
            var parent = null
            for (var tab in tabs) {
                tab = tabs[tab]
                if (tab.className === "tab") {
                    if (tab.id === id) {
                        parent = tab.parentElement
                        tab.style.display = "block"
                    } else {
                        tab.style.display = "none"
                    }
                }
            }
            for (var screen in screens) {
                screen = screens[screen]
                if (screen.className === "screen") {
                    if (screen.id === parent.id) {
                        screen.style.display = "flex"
                    } else {
                        screen.style.display = "none"
                    }
                }
            }
            if (["home", "missions", "communities", "inbox"].includes(id.split("-")[0])) {
                for (var tab in tabs) {
                    tab = tabs[tab]
                    if (tab.className === "tab" && ["home", "missions", "communities", "inbox"].includes(tab.id.split("-")[0])) {
                        if (tab.id === id) {
                            if (tab.getAttribute("href")) window.history.pushState({}, "", tab.getAttribute("href"))
                            document.getElementById(`navigation-${tab.id.split("-")[0]}`).className = "active"
                        } else {
                            document.getElementById(`navigation-${tab.id.split("-")[0]}`).className = ""
                        }
                    }
                }
            }
            console.log(id)
            if (id === "home-tab") {
                console.log(profile)
            } else if (id === "missions-tab") {
                if (!document.getElementById("missions-map").className && !map) {
                    map = L.map("missions-map").setView([51.505, -0.09], 13)
                    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
                    }).addTo(map)
                }
                console.log(profile)
                missions = await API.missions.all(profile.token[0])
                console.log(missions)
            } else if (id === "communities-tab") {

            } else if (id === "inbox-tab") {
                inbox = await API.inbox.all(profile.token[0])
                list = document.getElementById("inbox")
                list.innerHTML = ""
                Object.entries(inbox).forEach((mail) => {
                    mail = [mail, document.createElement("li")]
                    mail[1].innerHTML = `<a href="#${btoa(JSON.stringify(["inbox", mail[0][0]]))}">
                        <p class="sender">${mail[0][1].from}</p>
                        <p class="title">${mail[0][1].title}</p>
                        <p class="description">${mail[0][1].content.split("<br>").join(" ")}</p>
                        <p class="timestamp">09:11 PM</p>
                    </a>`
                    list.appendChild(mail[1])
                })
            } else if (id === "loading-tab") {
                if (localStorage.getItem("session")) {
                    profile = await API.accounts.authorizeToken(localStorage.getItem("session"))
                    if (profile.error) {
                        localStorage.removeItem("session")
                    } else {
                        selectTab("home-tab")
                    }
                } else {
                    selectTab("login-tab")
                }
            }
        }
        window.addEventListener("DOMContentLoaded", async () => {
            window.addEventListener("hashchange", (event) => {
                event.hash = JSON.parse(atob(window.location.hash.split("#")[1]))
                console.log(event.hash)
                if (event.hash[0] === "inbox") {
                    document.getElementById("inbox-overlay").style.display = "flex"
                    document.getElementById("mail-from").innerHTML = `<b>From</b> ` + inbox[event.hash[1]].from
                    document.getElementById("mail-title").textContent = `<b>Title</b>` + inbox[event.hash[1]].title
                    speak(inbox[event.hash[1]].content)
                }
                console.log(event.hash)
            })
            selectTab("loading-tab")
        })
    </script>
</html>